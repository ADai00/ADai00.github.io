---
layout: mypost
title: MySQL设计规约
categories: [ MySQL ]
---

# 一. 安全规范

- 【强制】禁止存储明文密码，需把密码加密后存储

# 二. 基础规范

- 【推荐】尽量不要在数据库做运算，复杂运算需移到业务应用里完成
- 【推荐】拒绝大sql语句，拒绝大事务，拒绝大批量，可转化到业务端完成
- 【推荐】避免使用存储过程，触发器，函数等
- 【强制】数据表，数据字段必须加中文注释
- 【强制】不在数据库中存储图片，文件等大数据
- 【推荐】所有研发SQL关键字全部小写，每个词只允许一个空格

# 三. 命名规范

- 【强制】库名，表名，字段名要小写，下划线风格，不超过32个字符，必须见名知意，建议使用名词而不是动词，词义与业务、产品线等相关联
- 【强制】普通索引命名格式：idx_表名_索引字段名,唯一索引命名格式：uk_表名_索引字段名，主键索引命名：pk_表段名
- 【强制】库名，表名，字段名禁止使用MySQL保留字
- 【强制】临时表名必须以tmp为前缀，并以日期为后缀
- 【强制】备份库表必须以bak为前缀，并以日期为后缀
- 【强制】表达是否概念的字段，使用is_xxx格式

# 四. 库设计规范

- 【推荐】数据库使用InnoDB存储引擎
- 【推荐】数据库和表的字符集统一使用UTF8,需要存储emoji字符时，使用utf8mb4
- 【推荐】不同业务，使用不同的数据库，避免互相影响

# 五. 表设计规范

- 【推荐】建表规范示例

```sql

CREATE TABLE `student_info`
(
    `id`           int(11) unsigned     NOT NULL AUTO_INCREMENT COMMENT '主键',
    `stu_name`     varchar(10)          NOT NULL DEFAULT '' COMMENT '姓名',
    `stu_score`    smallint(5) unsigned NOT NULL DEFAULT '0' COMMENT '总分',
    `stu_num`      int(11)              NOT NULL COMMENT '学号',
    `gmt_create`   timestamp            NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `gmt_modified` timestamp            NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `status`       tinyint(4)                    DEFAULT '1' COMMENT '1代表记录有效，0代表记录无效',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_student_info_stu_num` (`stu_num`) USING BTREE,
    KEY `idx_student_info_stu_name` (`stu_name`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8 COMMENT ='学生信息表';

```

- 【强制】禁止使用外键，如果有外键完整性约束，需应用程序控制
- 【强制】每个Innodb表必须有一个主键
- 【推荐】单表列数目最好小于50
- 【推荐】拆分大字段和访问频率低的字段，分离冷热数据
- 【推荐】单表不超过50个int字段；不超过20个char字段，不超过2个text字段
- 【推荐】表默认设置创建时间戳和更改时间戳字段
- 【强制】禁止使用order by rand()
- 【推荐】每张表数据量建议控制在500W以下，超过500w可以使用历史数据归档或分库分表来实现
- 【强制】禁止在表中建立预留字段

# 六. 字段设计规范

- 【强制】必须把字段定义为not null并且提供默认值

**说明**：null字段很难查询优化，null字段的索引需要额外空间，null字段的复合索引无效

- 【强制】禁止使用enum,使用tinyint代替
- 【强制】禁止使用text和blob类型
- 【强制】必须使用varchar(20)存储手机号
- 【强制】禁止使用小数存储国币，使用“分”为单位，这样数据库存储都是整数
- 【强制】用decimal代替float和double
- 【推荐】使用unsigned存储非负整数

**说明**: 同样的字节数，存储的数值范围越大

- 【推荐】字段长度尽量按实际需要进行分配，不要随意分配一个很大的容量
- 【推荐】核心表字段数量尽可能的少
- 【推荐】适当考虑一些反范式的表设计，增加冗余字段，减少join
- 【强制】存储状态，性别等，用tinyint
- 【参考】存储年使用year类型，存储日期使用date类型，存储时间（精确到秒）建议使用timestamp类型
- 【推荐】varchar(n),n>5000时，使用blob类型
- 【推荐】优先选择符合存储需要的最小数据类型
- 【推荐】如果存储的字符串长度几乎相等，使用char定长字符串类型

# 七. 索引设计规范

- 【推荐】单表索引建议控制在5个以内
- 【强制】禁止在更新频繁，区分度不高的属性上建立索引
- 【强制】建立组合索引必须把区分度高的字段放在前面
- 【推荐】对字符串使用索引，如果字符串定义长度超过128，可以考虑前缀索引
- 【强制】表必须有主键，并且是auto_increment及not null
- 【强制】禁止更新频繁的列作为主键
- 【强制】禁止字符串作为主键
- 【推荐】主键建议选择自增或发号器
- 【推荐】核心sql优先考虑覆盖索引
- 【参考】避免冗余和重复索引，如(a,b,c) 相当于(a),(a,b),(a,b,c)
- 【推荐】复合索引中字段数建议不超过5个
- 【推荐】where条件中的非等值条件（in,between,<,<=,>,>=） 会导致后面的条件使用不了索引
- 【推荐】不要在选择性低的列上建立索引，如性别，状态，类型
- 【强制】禁止给表中每一列都建立单独的索引

# 八. SQL使用规范

- 【强制】禁止使用select *，只获取必要字段
- 【强制】禁止使用insert into t_xxx values(xxx),必须显示指定插入的列属性
- 【强制】where条件必须使用合适的类型，避免隐式类型转化

**说明**：隐式类型转化导致索引失效

- 【强制】禁止在where条件的属性上使用函数或表达式
- 【强制】禁止负向查询，以及%开头的模糊查询
- 【推荐】sql中使用到or改写为in（or的效率没有in高）
- 【参考】in包含的值不应过多，建议控制在1000个以内
- 【推荐】尽量使用union all替代union
- 【参考】避免使用大表join
- 【推荐】获取大量数据时，建议分批次获取数据，每次获取数据少于2000条，结果集小于1M
- 【推荐】SQL 性能优化的目标：至少要达到 range 级别，要求是 ref 级别，如果可以是 consts最好
- 【推荐】尽量不要使用物理删除（即直接删除，如果要删除的话提前做好备份），而是使用逻辑删除，使用字段delete_flag做逻辑删除，类型为tinyint，0表示未删除，1表示已删除
- 【推荐】使用 ISNULL()来判断是否为 NULL 值
- 【强制】超过三个表禁止 join（需要 join 的字段，数据类型必须绝对一致；多表关联查询时，保证被关联的字段需要有索引。即使双表
  join 也要注意表索引、SQL 性能。）
- 【推荐】统计表中记录数时使用COUNT(*)，而不是COUNT(primary_key)和COUNT(1)

**说明**：count( * ) 会统计值为 NULL 的行，而 count( 列名 ) 不会统计此列为 NULL 值的行

# 九. 行为规范

- 【强制】禁止使用应用程序配置文件内的帐号手工访问线上数据库
- 【强制】禁止从测试、开发环境直连线上数据库
- 【强制】禁止在线上做数据库压力测试

# 十. 流程规范

- 【强制】所有的建表需要确定建立哪些索引后才可以建表上线
- 【强制】不在业务高峰期批量更新、查询数据库
- 【强制】核心业务数据库变更需在凌晨执行
- 【强制】线上数据库的变更操作必须提供对应的回滚方案