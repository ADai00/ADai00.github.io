---
layout: mypost
title: 一条SQL查询语句是如何执行的
categories: [ MySQL ]
---

# MySQL基本架构

![01.png](01.png)

大体上，MySQL可以分为Server层和存储引擎层。

Server层包括连接器、查询缓存、分析器、优化器、执行器等，

存储引擎层负责数据的存储和提取。其架构模式为插件式，支持InnoDB,MyISAM,Memory等多个存储引擎。InnoDB是最常用的存储引擎，MySQL
5.5.5版本开始成为默认存储引擎。

## 连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接。连接命令如下：

```sql
mysql -h$ip -P$port -u$user -p
```

用户名密码认证通过后，连接器会到权限表中查询用户拥有的权限。之后，这个连接里面的权限判断逻辑，都依赖读取到的权限。一旦用户成功建立连接后，即使修改这个用户权限，也不会影响已经存在连接的权限。

可以通过show processlist 查看数据库当前的所有连接。

![02.png](02.png)

客户端长时间处于空闲（Sleep）状态，连接器会自动断开连接，这个时间由参数wait_timeout控制，默认8小时。

## 查询缓存

连接建立后，执行查询语句前，会先查询缓存。如果查询缓存中存在，直接返回结果，否则进入分析器。MySQL 8.0版本直接将查询缓存功能删除了。

## 分析器

MySQL需要知道你要做什么，因此需要对SQL语句进行解析。

首先，做“词法分析”，获取到查询语句中的表和列。

然后，做“语法分析”，判断输入的SQL是否满足MySQL语法，如果语句不对，会收到“You have an error in your SQL syntax”错误提醒。

## 优化器

优化器是在表里面有多个索引的时候，决定使用那个索引；或者在一个多表关联的时候，决定各个表的连接顺序。

## 执行器

开始执行之前，会先判断当前用户是否有表的查询权限，如果没有，就返回没有权限的错误。如果有权限，就打开表执行，打开表时，执行器会根据表的引擎定义，去使用引擎提供的接口。
