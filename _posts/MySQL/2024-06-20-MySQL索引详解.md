---
layout: mypost
title: MySQL索引详解
categories: [ MySQL ]
---

# 索引介绍

索引是一种用于快速查询和检索数据的数据结构，其本质可以看成是一种排好序的数据结构

## 优缺点
**优点**
- 使用索引可以大大加快数据的检索速度，减少IO次数
- 通过创建唯一性索引，可以保证数据库表中每行数据的唯一性

**缺点**
- 创建和维护索引需要耗费许多时间。当对表中的数据进行增删改的时候，如果数据有索引，那么索引也需要动态修改，这会降低sql执行效率。
- 索引需要使用物理文件进行存储，也会耗费一定空间

# B+树

## B+树的逻辑结构

- 在叶子节点一层，所有记录的主键按照大小顺序排列，并且形成一个双向链表。叶子节点每个key都指向一条记录。
- 非叶子节点取的是叶子节点里面key的最小值。同一层非叶子节点相互串联，也形成一个双向链表。

![01.png](01.png)

## B+树的物理结构

以InnoDB引擎为例，对于磁盘来说，不可能一条一条的读写，而都是以‘块‘为单位进行读写。InnoDB默认块的大小为16KB,通过innodb_page_size参数指定。

- 第一层：一个节点是一个Page，里面存放了1000个key,对应1000个叶子节点。
- 第二层：1000个节点，1000个Page,每个Page里面装1000个key。
- 第三层：1000 * 1000个节点，每个Page里装200条记录，及是1000 * 1000 * 200=2亿条记录

![02.png](02.png)

Page和Page之间组成双向链表，每个Page头部有两个关键字段：前一个Page的编号，后一个Page的编号。Page里面存储一条条记录，记录之间用单向链表串联。

![03.png](03.png)

# 索引类型总结

按存储方式划分：
- 聚簇索引：索引结构和数据一起存放的索引，InnoDB中的主键索引就属于聚簇索引
- 非聚簇索引：索引结构与数据分开存放的索引，二级索引就属于非聚簇索引。

按照应用维度划分：
- 主键索引：加速查询+列值唯一（不可以为null）+表中只有一个
- 普通索引：仅加速查询
- 唯一索引：加速查询+列值唯一（可以为null）
- 覆盖索引：一个索引包含（覆盖）所有要查询的字段的值
- 联合索引：多列值组成一个索引，专门用于组合搜索，其效率大于索引合并
- 全文索引：对文本内容进行分词，进行搜索。目前只有char,varchar,text列上可以创建全文索引。一般不使用，效率低，通常使用es替代。
- 前缀索引：对文本的前几个字符创建索引，相比普通索引建立的数据更小

# 主键索引

表的主键列就是使用的主键索引

# 二级索引

二级索引叶子节点存储的数据是主键的值，需根据主键再回表查询数据

唯一索引，普通索引，前缀索引等索引都属于二级索引。

- **唯一索引**：唯一索引也是一种约束。唯一索引的属性列不能出现重复数据，但允许为null,一张表允许创建多个唯一索引。唯一索引的目的是为了该属性列的数据的唯一性，而不是为了查询效率。
- **普通索引**：普通索引的唯一作用就是为了快速查询数据。一张表允许创建多个普通索引，并允许数据重复和null。
- **前缀索引**：前缀索引只适用于字符串类型的数据。前缀索引是对文本的前几个字符创建索引，相比普通索引建立的数据更小。
- **全文索引**：全文索引主要是为了检索大文本数据中的关键字的信息，是目前搜索引擎数据库适用的一种技术。

# 聚簇索引和非聚簇索引

聚簇索引及索引结构和数据一起存放的索引，如：主键索引

非聚簇索引及索引结构和数据分开存放的索引，如：二级索引

# 覆盖索引和联合索引

覆盖索引：一个索引包含所有要查询的字段的值，称为覆盖索引

联合索引：使用表的多个字段创建索引

## 最左前缀匹配原则

最左前缀匹配原则指的是在使用联合索引时，MySQL 会根据索引中的字段顺序，从左到右依次匹配查询条件中的字段。

最左匹配原则会一直向右匹配，直到遇到范围查询（如 >、<）为止。对于 >=、<=、BETWEEN 以及前缀匹配 LIKE 的范围查询，不会停止匹配。

# 正确使用索引的一些建议

## 适合创建索引的字段
- **不为null的字段**：索引字段的数据尽量不为null,对于null数据，数据库较难优化。
- **频繁查询的字段**：创建索引的字段应该是查询操作非常频繁的字段。
- **作为查询条件的字段**：被作为where条件的查询字段，应该考虑建立索引
- **频繁需要排序的字段**：索引已经排序，这样查询可以利用索引的排序，加快排序查询时间
- **经常频繁用于连接的字段**：对于频繁被连接查询的字段，可以考虑建立索引，提高多表连接的查询效率。

## 被频繁更新的字段应慎重建立索引
虽然索引能带来查询上的效率，但是维护索引的成本也不小。如果一个字段不被经常查询，反而被经常修改，那么就不应该在这种字段上建立索引。

## 限制每张表上的索引数量
建议单张表索引不超过5个！

## 尽可能考虑建立联合索引而不是单列索引
索引需要占用磁盘空间，如果一个表索引过多，当表的数据达到一定体量时，索引占用的空间也会很多，且修改索引时，耗费的时间也是较多的。如果是联合索引，多个字段在一个索引上
，那么将会节约很大的磁盘空间，且修改数据的操作效率也会提升。

## 避免索引冗余
冗余索引指的是索引的功能相同，能够命中索引（a,b）就肯定能命中索引（a）,那么索引（a）就是冗余索引。

## 避免索引失效

索引失效也是慢查询的主要原因之一，常见的导致索引失效的情况

- 未遵守最左匹配原则
- 在索引列上进行计算，函数，类型转化等操作
- OR 的前后条件中有一个列没有索引，涉及的索引都不会被使用到
- IN 的取值范围较大（NOT IN 与 IN 失效场景相同）
- 以%开头的LIKE查询，如 LIKE '%abc'
- 发生隐式转换







